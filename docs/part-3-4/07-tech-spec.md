# ğŸ“‹ ì´ì»¤ë¨¸ìŠ¤ ìƒí’ˆ ì£¼ë¬¸ ì‹œìŠ¤í…œ ê¸°ìˆ  ëª…ì„¸ì„œ

## 1. ì‹œìŠ¤í…œ ê°œìš”

### 1.1 ëª©ì 

ë””ì§€í„¸ ìƒí’ˆ ì£¼ë¬¸ ë° ê²°ì œ ì‹œìŠ¤í…œìœ¼ë¡œ, ì‚¬ìš©ì ì”ì•¡ê³¼ ì¿ í°ì„ í™œìš©í•œ ì•ˆì „í•œ ê±°ë˜ ì²˜ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### 1.2 ì£¼ìš” ê¸°ëŠ¥

- ì‚¬ìš©ì ì”ì•¡ ì¶©ì „ ë° ê´€ë¦¬
- ë””ì§€í„¸ ìƒí’ˆ ì£¼ë¬¸ ë° ê²°ì œ
- ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰ ë° ì‚¬ìš©
- ì¬ê³  ê´€ë¦¬ ë° ë™ì‹œì„± ì œì–´
- ì‹¤íŒ¨ ìƒí™© ìë™ ë³µêµ¬
- ì¸ê¸° ìƒí’ˆ í†µê³„ ë° ì¶”ì²œ

## 2. ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 2.1 ì „ì²´ êµ¬ì¡°

```mermaid
graph TB
    subgraph "Load Balancer"
        LB[Load Balancer]
    end

    subgraph "Application Instances"
        I1[Instance 1]
        I2[Instance 2]
        I3[Instance 3]
    end

    subgraph "Shared Resources"
        DB[(MySQL)]
        R[(Redis)]
        K[(Kafka)]
    end

    subgraph "Critical Sections"
        CS1[ì¬ê³  ê´€ë¦¬]
        CS2[ì¿ í° ë°œê¸‰]
        CS3[ë°°ì¹˜ ì‘ì—…]
    end

    LB --> I1
    LB --> I2
    LB --> I3

    I1 --> DB
    I2 --> DB
    I3 --> DB

    I1 --> R
    I2 --> R
    I3 --> R

    I1 --> K
    I2 --> K
    I3 --> K

    I1 -.-> CS1
    I2 -.-> CS1
    I3 -.-> CS1

    I1 -.-> CS2
    I2 -.-> CS2
    I3 -.-> CS2

    I1 -.-> CS3
    I2 -.-> CS3
    I3 -.-> CS3

    CS1 --> DB
    CS2 --> R
    CS3 --> R

    style CS1 fill:#333
    style CS2 fill:#333
    style CS3 fill:#333
```

**ë™ì‹œì„± ì œì–´ ì˜ì—­ ì„¤ëª…:**

- **CS1 (ì¬ê³  ê´€ë¦¬)**: DB í•„ë“œ ê¸°ë°˜ reserve/release íŒ¨í„´
- **CS2 (ì¿ í° ë°œê¸‰)**: Redis ì›ìì  ì—°ì‚° (INCR/DECR)
- **CS3 (ë³´ë¥˜ ì£¼ë¬¸ ë³µêµ¬)**: Redis ë¶„ì‚° ë½ (SET NX EX)

### 2.2 ëª¨ë“ˆ êµ¬ì¡°

```
src/
â”œâ”€â”€ auth/           # JWT ì¸ì¦ ë° ì‚¬ìš©ì ê´€ë¦¬
â”œâ”€â”€ user/           # ì‚¬ìš©ì í”„ë¡œí•„ ê´€ë¦¬
â”œâ”€â”€ product/        # ìƒí’ˆ ì¡°íšŒ ë° ê´€ë¦¬
â”œâ”€â”€ order/          # ì£¼ë¬¸ ì²˜ë¦¬ í•µì‹¬ ë¡œì§
â”œâ”€â”€ wallet/         # ì”ì•¡ ì¶©ì „ ë° ê²°ì œ
â”œâ”€â”€ coupon/         # ì¿ í° ë°œê¸‰ ë° ì‚¬ìš©
â”œâ”€â”€ stats/          # ì¸ê¸° ìƒí’ˆ í†µê³„
â”œâ”€â”€ recovery/       # ì‹¤íŒ¨ ì£¼ë¬¸ ë³µêµ¬
â””â”€â”€ database/       # ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
```

## 3. ê¸°ìˆ  ìŠ¤íƒ

| êµ¬ë¶„         | ê¸°ìˆ          | ë²„ì „  | ëª©ì                                           |
| ------------ | ------------ | ----- | --------------------------------------------- |
| ëŸ°íƒ€ì„       | Node.js      | 18.x  | ì„œë²„ ì‚¬ì´ë“œ JavaScript ì‹¤í–‰                   |
| í”„ë ˆì„ì›Œí¬   | NestJS       | 10.x  | ì—”í„°í”„ë¼ì´ì¦ˆê¸‰ Node.js í”„ë ˆì„ì›Œí¬             |
| ë°ì´í„°ë² ì´ìŠ¤ | MySQL        | 8.x   | ê´€ê³„í˜• ë°ì´í„° ì €ì¥ ë° íŠ¸ëœì­ì…˜                |
| ìºì‹œ         | Redis        | 7.x   | ì¿ í° ë°œê¸‰ ë™ì‹œì„± ì œì–´, ë³´ë¥˜ ì£¼ë¬¸ ë³µêµ¬ ë¶„ì‚° ë½ |
| ë©”ì‹œì§•       | Kafka (Mock) | -     | ì£¼ë¬¸ ì´ë²¤íŠ¸ ë¡œê¹…                              |
| ORM          | TypeORM      | 0.3.x | ë°ì´í„°ë² ì´ìŠ¤ ORM                              |
| ì¸ì¦         | JWT          | -     | ë¬´ìƒíƒœ ì¸ì¦                                   |

## 4. í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ í”Œë¡œìš°

### 4.1 ì£¼ë¬¸ ì²˜ë¦¬ í”Œë¡œìš°

```mermaid
flowchart TD
    Start([ì£¼ë¬¸ ì‹œì‘]) --> Auth{ì‚¬ìš©ì ì¸ì¦}
    Auth -->|ì„±ê³µ| StockCheck[ì¬ê³  í™•ì¸]
    Auth -->|ì‹¤íŒ¨| Fail([ì£¼ë¬¸ ì‹¤íŒ¨])

    StockCheck --> StockOK{ì¬ê³  ì¶©ë¶„?}
    StockOK -->|Yes| StockReserve[ì¬ê³  ì„ì‹œ í™•ë³´]
    StockOK -->|No| Fail

    StockReserve --> CouponCheck{ì¿ í° ì‚¬ìš©?}
    CouponCheck -->|Yes| CouponValidate[ì¿ í° ìœ íš¨ì„± ê²€ì¦]
    CouponCheck -->|No| BalanceCheck[ì”ì•¡ í™•ì¸]

    CouponValidate --> CouponOK{ì¿ í° ìœ íš¨?}
    CouponOK -->|Yes| BalanceCheck
    CouponOK -->|No| StockRelease[ì¬ê³  í•´ì œ] --> Fail

    BalanceCheck --> BalanceOK{ì”ì•¡ ì¶©ë¶„?}
    BalanceOK -->|Yes| PaymentProcess[ê²°ì œ ì²˜ë¦¬]
    BalanceOK -->|No| StockRelease

    PaymentProcess --> PaymentOK{ê²°ì œ ì„±ê³µ?}
    PaymentOK -->|Yes| StockConfirm[ì¬ê³  í™•ì •]
    PaymentOK -->|No| Pending[ë³´ë¥˜ ì²˜ë¦¬]

    StockConfirm --> StockConfirmOK{ì¬ê³  í™•ì • ì„±ê³µ?}
    StockConfirmOK -->|Yes| CouponUse[ì¿ í° ì‚¬ìš© ì²˜ë¦¬]
    StockConfirmOK -->|No| Pending

    CouponUse --> CouponUseOK{ì¿ í° ì‚¬ìš© ì„±ê³µ?}
    CouponUseOK -->|Yes| Success([ì£¼ë¬¸ ì™„ë£Œ])
    CouponUseOK -->|No| Pending

    Pending --> Timer[1ë¶„ ëŒ€ê¸°]
    Timer --> Recovery[ìë™ ë³µêµ¬]
    Recovery --> RecoveryEnd[ë¦¬ì†ŒìŠ¤ ë°˜í™˜] --> Fail

    style StockCheck color:#111,fill:#ffeb3b
    style PaymentProcess color:#111,fill:#ff9800
    style Pending color:#111,fill:#f44336
    style Recovery color:#111,fill:#9c27b0
```

## 5. ë°ì´í„° ëª¨ë¸ ë° ì œì•½ì‚¬í•­

### 5.1 í•µì‹¬ ì—”í‹°í‹°

| ì—”í‹°í‹°          | ì£¼ìš” ì†ì„±                                       | ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™                  |
| --------------- | ----------------------------------------------- | ------------------------------ |
| **User**        | id, email, name                                 | ì´ë©”ì¼ ì¤‘ë³µ ë¶ˆê°€               |
| **Product**     | id, name, price, total_stock, reserved_stock    | ê°€ê²©ì€ 100ì› ë‹¨ìœ„, ì¬ê³ ëŠ” ì–‘ìˆ˜ |
| **Order**       | id, user_id, total_amount, final_amount, status | ìµœì¢… ê¸ˆì•¡ì€ ì–‘ìˆ˜, ìƒíƒœë³„ ì²˜ë¦¬  |
| **UserBalance** | user_id, balance                                | ìµœì†Œ 0ì›, ìµœëŒ€ ì²œë§Œì›          |
| **Coupon**      | id, code, type, discount_value, total_quantity  | ì‚¬ìš©ëŸ‰ â‰¤ ì´ëŸ‰                  |
| **UserCoupon**  | user_id, coupon_id, status                      | ì‚¬ìš©ìë‹¹ ì¤‘ë³µ ë°œê¸‰ ë¶ˆê°€        |

### 5.2 ë°ì´í„° ë¬´ê²°ì„± ì œì•½

#### ê¸ˆì•¡ ì²˜ë¦¬ ì •ì±…

- **ëª¨ë“  ê¸ˆì•¡ì€ ì •ìˆ˜(ì› ë‹¨ìœ„)ë¡œ ì²˜ë¦¬** - ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ ë°©ì§€
- í• ì¸ ê³„ì‚° ì‹œ **ì†Œìˆ˜ì  ë²„ë¦¼** ì ìš©: `í• ì¸ê¸ˆì•¡ = ì›ê°€ Ã— í• ì¸ìœ¨ Ã· 100` (ì •ìˆ˜ ë‚˜ëˆ—ì…ˆ)
- ì˜ˆì‹œ: 1,235ì› Ã— 10% = 123ì› (ì†Œìˆ˜ì  ë²„ë¦¼)

#### ì¬ê³  ê´€ë¦¬ ì œì•½

- `total_stock â‰¥ reserved_stock â‰¥ 0`
- `available_stock = total_stock - reserved_stock`
- ìƒí’ˆë‹¹ ìµœëŒ€ ì£¼ë¬¸ ìˆ˜ëŸ‰: 10ê°œ
- í•œ ì£¼ë¬¸ ë‚´ ì´ ìˆ˜ëŸ‰: ìµœëŒ€ 30ê°œ

#### ì”ì•¡ ê´€ë¦¬ ì œì•½

- `balance â‰¥ 0` (ìŒìˆ˜ ì”ì•¡ ë¶ˆê°€)
- ìµœì†Œ ì¶©ì „: 1,000ì›, ìµœëŒ€ ì¶©ì „: 100,000ì›
- ì´ ë³´ìœ  í•œë„: 10,000,000ì›
- ì¶©ì „ ë‹¨ìœ„: 10ì›

## 6. ë™ì‹œì„± ì œì–´ ì „ëµ

### 6.1 ì¬ê³  ê´€ë¦¬

**Reserve/Release íŒ¨í„´ (DB í•„ë“œ ê¸°ë°˜)**

```sql
-- ì¬ê³  ì˜ˆì•½
UPDATE products
SET reserved_stock = reserved_stock + ?
WHERE id = ? AND (total_stock - reserved_stock) >= ?

-- ì¬ê³  í™•ì •
UPDATE products
SET total_stock = total_stock - ?, reserved_stock = reserved_stock - ?
WHERE id = ?

-- ì¬ê³  í•´ì œ
UPDATE products
SET reserved_stock = reserved_stock - ?
WHERE id = ?
```

**TTL ê¸°ë°˜ ìë™ í•´ì œ**

- 30ì´ˆ í›„ ìë™ ì˜ˆì•½ í•´ì œ
- 5ë¶„ë§ˆë‹¤ ë°°ì¹˜ë¡œ ë§Œë£Œëœ ì˜ˆì•½ ì •ë¦¬

### 6.2 ì¿ í° ë°œê¸‰ (Redis ì›ìì  ì—°ì‚°)

```javascript
// ì„ ì°©ìˆœ ì¿ í° ë°œê¸‰
const usedCount = await redis.incr(`coupon:used:${couponCode}`);
const totalCount = await redis.get(`coupon:total:${couponCode}`);

if (usedCount > parseInt(totalCount)) {
  await redis.decr(`coupon:used:${couponCode}`); // ë¡¤ë°±
  throw new Error("ì¿ í° ì†Œì§„");
}
```

### 6.3 ë³´ë¥˜ ì£¼ë¬¸ ë³µêµ¬ (Redis ë¶„ì‚° ë½)

```javascript
// ì¤‘ë³µ ë°°ì¹˜ ì‹¤í–‰ ë°©ì§€
const lockKey = `recovery:${orderId}`;
const lockAcquired = await redis.set(lockKey, "locked", "PX", 60000, "NX");

if (lockAcquired === "OK") {
  try {
    await recoverOrder(orderId);
  } finally {
    await redis.del(lockKey);
  }
}
```

### 6.4 ì”ì•¡ ê´€ë¦¬ (ë¹„ê´€ì  ë½)

```sql
-- ì”ì•¡ ì°¨ê° ì‹œ í–‰ ë‹¨ìœ„ ë½
SELECT balance FROM user_balances WHERE user_id = ? FOR UPDATE;
UPDATE user_balances SET balance = balance - ? WHERE user_id = ?;
```

## 7. ì„±ëŠ¥ ë° í™•ì¥ì„±

### 7.1 ì„±ëŠ¥ ì§€í‘œ

| ë©”íŠ¸ë¦­             | ëª©í‘œê°’   | ì¸¡ì • ë°©ë²•                |
| ------------------ | -------- | ------------------------ |
| ì£¼ë¬¸ ì²˜ë¦¬ ì§€ì—°ì‹œê°„ | < 2ì´ˆ    | API ì‘ë‹µ ì‹œê°„ ì¸¡ì •       |
| ë™ì‹œ ì£¼ë¬¸ ì²˜ë¦¬ëŸ‰   | 1000 TPS | ë¶€í•˜ í…ŒìŠ¤íŠ¸              |
| ì¬ê³  ì¶©ëŒ ì‹¤íŒ¨ìœ¨   | < 5%     | ë™ì‹œ ì£¼ë¬¸ ì‹œ ì‹¤íŒ¨ ë¹„ìœ¨   |
| ìë™ ë³µêµ¬ ì„±ê³µë¥    | > 99%    | ë³´ë¥˜ ì£¼ë¬¸ ë³µêµ¬ ì„±ê³µ ë¹„ìœ¨ |

### 7.2 í™•ì¥ì„± ê³ ë ¤ì‚¬í•­

#### ìˆ˜í‰ í™•ì¥ (Scale-out)

- **ë¬´ìƒíƒœ API**: JWT í† í° ê¸°ë°˜ ì¸ì¦ìœ¼ë¡œ ì„¸ì…˜ ì˜ì¡´ì„± ì œê±°
- **ë°ì´í„°ë² ì´ìŠ¤ ë¶„í• **: ì‚¬ìš©ì ê¸°ë°˜ ìƒ¤ë”© ê³ ë ¤ (í˜„ì¬ëŠ” ìœ ì € ë°ì´í„° ë¼ë¦¬ì˜ ì†Œí†µì´ ì—†ìŒ!)
- **Redis ë¶„ì‚°**: ì¿ í° ë°œê¸‰ ë° ë¶„ì‚° ë½ìš© Redis Cluster ë„ì… ê°€ëŠ¥
- **ì›¹ ì„œë²„ ë³µì œ**: ì˜¤í†  ìŠ¤ì¼€ì¼ë§ ë¡œë“œ ë°¸ëŸ°ì„œ ë„ì… ê°€ëŠ¥

#### ì„±ëŠ¥ ìµœì í™”

- **ì¸ê¸° ìƒí’ˆ í†µê³„**: ë³„ë„ ì§‘ê³„ í…Œì´ë¸” ë˜ëŠ” Redis ìºì‹œ í™œìš© (3ì¼ê°„ íŒë§¤ëŸ‰ ê¸°ì¤€)
- **íŒŒí‹°ì…”ë‹**: `point_transactions`, `orders` í…Œì´ë¸” ì›”ë³„ íŒŒí‹°ì…”ë‹
- **ì¸ë±ìŠ¤ ìµœì í™”**:
  - `orders`: (user_id), (status), (created_at)
  - `products`: (is_active), (total_stock)
  - `user_coupons`: (user_id, coupon_id) ë³µí•© ìœ ë‹ˆí¬

## 8. ì˜ˆì™¸ ì²˜ë¦¬ ë° ë³µêµ¬

### 8.1 ì‹¤íŒ¨ ì‹œë‚˜ë¦¬ì˜¤ë³„ ì²˜ë¦¬

| ì‹¤íŒ¨ ì›ì¸    | ì²˜ë¦¬ ë°©ì‹ | ë³µêµ¬ ë°©ë²•        |
| ------------ | --------- | ---------------- |
| ì”ì•¡ ë¶€ì¡±    | ì£¼ë¬¸ ê±°ì ˆ | ì¬ê³  ì˜ˆì•½ í•´ì œ   |
| ì¬ê³  ë¶€ì¡±    | ì£¼ë¬¸ ê±°ì ˆ | ì¦‰ì‹œ ì‹¤íŒ¨ ì‘ë‹µ   |
| ì¿ í° ì˜¤ë¥˜    | ì£¼ë¬¸ ê±°ì ˆ | ì¬ê³  ì˜ˆì•½ í•´ì œ   |
| ê²°ì œ ì¤‘ ì˜¤ë¥˜ | ë³´ë¥˜ ì²˜ë¦¬ | 1ë¶„ í›„ ìë™ ë³µêµ¬ |

### 8.2 ìë™ ë³µêµ¬ ì‹œìŠ¤í…œ

- **ë³´ë¥˜ ì£¼ë¬¸**: 1ë¶„ í›„ ì”ì•¡/ì¬ê³ /ì¿ í° ìë™ ë³µì›
- **ë§Œë£Œ ì˜ˆì•½**: 30ì´ˆ í›„ ì¬ê³  ì˜ˆì•½ ìë™ í•´ì œ
- **ë¶„ì‚° ë½ TTL**: Redis ë‚´ì—ì„œ 60ì´ˆ í›„ ìë™ ë½ í•´ì œ (í”„ë¡œì„¸ìŠ¤ ì¥ì•  ëŒ€ë¹„)

### 8.3 ì¤‘ë³µ ìš”ì²­ ë°©ì§€

- **ë©±ë“±ì„± í‚¤**: í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì‹œ `requestId` í¬í•¨ (í”„ë¡ íŠ¸ì—ì„œ ìƒì„±í•´ì•¼í• ë“¯)
- **ì¤‘ë³µ ê²€ì¦**: ë™ì¼ `requestId` ê¸°ì¡´ ê²°ê³¼ ë°˜í™˜
- **ë™ì‹œ ìš”ì²­**: ìµœì´ˆ ìŠ¹ì¸ë§Œ ìœ íš¨, ë‚˜ë¨¸ì§€ ì‹¤íŒ¨ ì²˜ë¦¬

## 9. ë³´ì•ˆ ë° ì œí•œ ì •ì±…

### 9.1 ì‚¬ìš©ì í–‰ìœ„ ì œí•œ

- ì£¼ë¬¸ ìš”ì²­: **ì´ˆë‹¹ 1íšŒ ì´í•˜**
- ì¿ í° ë°œê¸‰: **1ë¶„ë‹¹ ìµœëŒ€ 3íšŒ**
- ì—°ì† ì‹¤íŒ¨: **5íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ 10ë¶„ê°„ ì œí•œ**

### 9.2 ë°ì´í„° ë³´ì¡´

- **ê±°ë˜ ì´ë ¥**: `point_transactions` ì‚­ì œ ë¶ˆê°€ (INSERT ONLY)
- **ì£¼ë¬¸ ì´ë ¥**: `orders`, `order_items` ì‚­ì œ ë¶ˆê°€, ìƒíƒœë§Œ ë³€ê²½
- **ê°ì‚¬ ì¶”ì **: ëª¨ë“  ì”ì•¡ ë³€ë™ ê¸°ë¡ ì˜ë¬´

## 10. ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

### 10.1 í•µì‹¬ ë©”íŠ¸ë¦­

- ì£¼ë¬¸ ì„±ê³µë¥ , ê²°ì œ ì‹¤íŒ¨ìœ¨
- ì¬ê³  ì¶©ëŒ ë°œìƒë¥ 
- ìë™ ë³µêµ¬ ì„±ê³µë¥ 
- API ì‘ë‹µ ì‹œê°„ ë¶„í¬

### 10.2 ì•Œë¦¼ ê¸°ì¤€

- ê²°ì œ ì‹¤íŒ¨ìœ¨ > 10%
- ìë™ ë³µêµ¬ ì‹¤íŒ¨ìœ¨ > 1%
- API ì‘ë‹µ ì‹œê°„ > 3ì´ˆ
- ë™ì‹œ ì ‘ì†ì > ì„ê³„ê°’
