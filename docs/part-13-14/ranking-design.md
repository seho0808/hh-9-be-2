## 요구사항

e-commerce 가장 많이 주문한 상품 랭킹을 Redis 기반으로 개발하고 설계 및 구현

<br/>

## 전제

- 오늘 일어나는 것이 실시간 반영되는 것이 아니라면 db 집계 쿼리 캐싱으로 구현하는 것이 대부분의 상황에서 더 유지보수 편할 것이라고 생각하여 무조건 오늘 일어나는 것이 반영된다고 전제했습니다.
- 무조건 sorted set을 쓴다고 가정했습니다. 다른 자료구조는 랭킹을 만드려면 구현과 최적화가 훨씬 까다로워서 배제했습니다.
- 일 별로 통계를 낸다고 가정했습니다. 시간 대 별로 통계를 내는 경우는 배제했습니다. 시간 단위로 정확성이 필요하다면 관리+성능 코스트 대비 db로 구현하고 결과 캐싱하는게 효율적일 수도 있습니다. 트래픽이 많아지면 데이터 엔지니어링에 가까운 처리가 필요할 수도 있다고 생각했습니다.

<br/>

## 일자 별로 통계를 내야 할 경우. zset 구현 선택지:

### 옵션 1) 1일 1일 1일 + zunionstore

- zunionstore의 경우 결국엔 각 일자의 상품 갯수 많아지면 비효율적이니 각 날짜는 최상위 K를 잘라서 합산하는 것이 효율적이라고 생각했습니다. 다만 최상위 K가 순위의 최소 4~6배수 정도이면 안정적으로 랭킹에서 놓치는 것 없이 계산할 수 있다고 생각했습니다. (상황에 따라서 조절)

### 옵션 2) 1일 2일 3일 누적 zset 세 개

- zunionstore을 자주 쓸 필요가 없습니다.
- 주문 수가 많아지면 zset 세 개에 write 총 세번씩 하는 것이 부담되기 시작할 수 있습니다.
- 롤업 방식을 이용하여 최적화할 수 있습니다. N번 (N은 일자수) 만큼의 write 대신 무조건 2번으로 해결할 수 있습니다. 매일 자정에 첫 날짜 것을 총합에서 빼는 방식입니다:
  - 7일 기준으로:
    - 쓸 때

      ```
      ZINCRBY day:today <delta> <product>
      ZINCRBY rollup:7d <delta> <product>
      ```

    - 자정 롤오버

      ```
      # 7일 전 키를 음수 가중치로 롤업에서 제거
      ZUNIONSTORE rollup:7d:tmp 2 rollup:7d day:YYYY-MM-DD-7 WEIGHTS 1 -1 AGGREGATE SUM
      RENAME rollup:7d:tmp rollup:7d
      ```

<br/>

## 최종 선택:

- 옵션 2에 롤업 방식을 선택했습니다.
- write cost가 가장 적고 정확하며 유지보수도 어렵지 않을 것이라 생각했습니다.

<br/>
