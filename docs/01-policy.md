# 이커머스 상품 주문 시스템 정책 문서

## 1. 목적

사용자가 여러 상품을 선택해 주문할 수 있는 디지털 상품 주문 서비스를 구축한다.  
잔액 기반 결제, 쿠폰 할인, 재고 차감, 주문 실패 복구, 인기 상품 추천, 마케팅 대응 유연성을 모두 포함하며, 예외 상황에도 신뢰 가능한 거래 경험을 보장한다.

## 2. 주요 개념

- **상품**: 디지털/무형 제품. 단가, 재고 수량 보유
- **쿠폰**: 선착순 또는 타겟팅 할인권. 주문 시 조건부 사용
- **잔액**: 사용자가 선충전한 금액. 결제 시 차
- **주문**: 복수 상품을 포함할 수 있는 사용자 요청
- **장바구니**: 상품을 담아두는 개념은 없으며, 즉시 주문 중심

## 3. 잔액 정책

### 3.1 충전 조건

- 최소 충전 금액: **1,000원**
- 1회 최대 충전: **100,000원**
- 사용자 총 보유 가능 잔액: **10,000,000원**
- 충전 단위: **10원 단위** (정수 처리)
- **모든 잔액은 정수로 저장 및 처리**

### 3.2 사용 조건

- 주문 결제 시 사용
- 주문 성공 시 즉시 차감됨
- **실패한 주문은 ‘보류 상태’로 먼저 처리되며**, 이후 오류가 확정되면 자동 복구됨

### 3.3 동시성 및 예외

- **재고가 1개 남았을 때 동시 주문 요청이 들어올 경우**, 최초로 재고를 확보(예약)한 유저가 결제 우선권이 있으며 나머지 유저들은 해당 유저가 결제에 실패하거나 등의 이유로 재고를 예약 해제했을 때 다시 주문 가능.
- **사용자가 브라우저를 닫거나 강제 종료한 경우**, 보류된 잔액은 **최대 1분 이내 자동 복구**

## 4. 상품 정책

### 4.1 기본 정보

- 상품 단가: **100원 단위** (정수 처리)
- 상품 단가 범위: **0원 이상 10,000,000원 이하**
- 최대 구매 가능 수량: **상품당 10개**
- 한 주문 내 전체 수량: **최대 30개**
- **모든 상품 가격은 정수로 저장 및 처리**

### 4.2 재고 정책

- 상품은 재고가 0일 경우 구매 불가
- **재고는 주문 요청 시점이 아닌 결제 직전에 확정됨**
- 재고는 ‘임시 예약’ 가능하며, **결제 도중 실패 시 재고는 복구됨**
- 예약 재고는 최대 **30초 동안 유효**, 이내 결제되지 않으면 해제됨

## 5. 쿠폰 정책

### 5.1 발급

- 쿠폰은 선착순 수량 제한이 있으며, **타임 이벤트**로 진행됨.
- 발급 조건 예시:
  - 총 500장 한정, 6월 20일까지 발급 가능, 2주동안 사용 가능.
- 중복 발급 방지: 동일 쿠폰은 사용자당 1회만 발급

### 5.2 사용

- 쿠폰은 주문 시 적용하며, 다음 조건 충족 시 유효:
  - 유효 기간 내
  - 최소 결제 금액 만족
  - 대상 상품 또는 전체 주문에 적용 가능
- 할인은 총 주문 금액 기준으로 계산됨
- **쿠폰은 주문 실패 시 자동 복구됨**

### 5.3 할인 방식

- 할인율 예: 10%, 20%
- 정액 할인 예: 2,000원 고정 할인
- **할인 상한선** 존재: 예) 최대 5,000원

### 5.4 소수점 처리 정책

- **모든 금액은 정수로 처리**하여 부동소수점 오차 방지
- 할인 계산 시 **소수점 버림** 정책 적용
- 할인율 계산 예시:
  ```
  주문 금액: 1,235원
  할인율: 10%
  계산: 1,235 × 10 ÷ 100 = 123.5 → 123원 (소수점 버림)
  최종 금액: 1,235 - 123 = 1,112원
  ```
- 정액 할인은 원 단위 정수로 직접 차감
- **정수 연산으로 성능 향상** 및 **금액 계산 안정성 보장**

## 6. 주문 및 결제 정책

### 6.1 주문 생성

- 1회 주문에 상품 여러 개 포함 가능
- 상품별 수량 명시 필요
- 주문 요청 시:
  - 잔액 보유 여부 확인
  - 재고 임시 확보
  - 쿠폰 유효성 확인
- 위 조건을 모두 충족해야 **결제 시도 가능**

### 6.2 결제 처리

- 쿠폰 → 잔액 순서로 차감
- **모든 금액 계산은 정수 기반으로 처리**
- 결제 성공 시:
  - 상품별 재고 차감
  - 잔액 차감
  - 쿠폰 사용 처리
- **데이터 처리 순서는 원자적(완전히 수행되거나, 전혀 수행되지 않아야 함)이며 중단 없이 동기화됨**

### 6.3 금액 계산 정책

- 총 주문 금액 = Σ(상품 단가 × 수량)
- 할인 적용 후 금액 = 총 주문 금액 - 할인 금액
- 할인 금액 계산 시 **소수점 버림** 적용
- 최종 결제 금액은 **1원 단위 정수**로 처리

### 6.4 실패 대응

- 실패 원인 별 처리 방식:

| 원인         | 처리 방식                                       |
| ------------ | ----------------------------------------------- |
| 잔액 부족    | 주문 거절, 재고 확보 안됨                       |
| 재고 부족    | 주문 거절, 잔액 보류 없음                       |
| 쿠폰 오류    | 주문 거절, 쿠폰 미소모                          |
| 결제 중 오류 | 주문 ‘보류’ 처리 후, 1분 내 자동 복구 로직 작동 |

### 6.5 중복 요청

- 동일 사용자의 **동일 주문 요청은 1회만 허용**
- 재시도 시도 중이라면 **“처리 중” 상태 안내**
- 중복 결제 방지를 위한 **요청 ID or 타임스탬프 비교** 필요 (백엔드 처리)

## 7. 인기 상품 추천

### 7.1 기준

- 최근 **3일간(72시간)** 주문 수량 기준
- 수량 기준 → 동점 시 가장 최근 결제 기준
- 취소된 주문은 포함하지 않음

### 7.2 출력

- 상위 5개 상품
- 사용자에게 매일 한 번 이상 노출됨

## 8. 사용자 행태 대응

### 8.1 악의적 행위 방지

- 빠르게 여러 주문 요청 → 초당 1회 이하 제한
- 쿠폰 수령 시도 반복 → **1분당 최대 3회**
- 잦은 실패 사용자 → **임시 블록** (예: 5회 연속 실패 시 10분간 제한)

### 8.2 동시 창 처리

- 여러 탭에서 주문 시도할 수 있음 → **최초 승인만 유효**
- 쿠폰, 재고는 **1회성 리소스**로 간주 → 동시 요청 실패율 발생 가능 안내 필요

## 9. 시스템 정책

### 9.1 상태 정의

| 상태         | 설명                           |
| ------------ | ------------------------------ |
| 결제 요청 중 | 잔액 및 재고 확보 대기         |
| 결제 완료    | 모든 처리 성공                 |
| 결제 실패    | 처리 중 에러 발생              |
| 주문 보류    | 처리 실패 후 재시도 가능 상태  |
| 취소됨       | 유저 또는 시스템에 의해 무효화 |

### 9.2 복구 정책

- 주문 보류 상태는 **최대 1분 후 자동 정리**
  - 잔액 → 복구
  - 재고 → 재가용
  - 쿠폰 → 복원

## 10. 외부 데이터 로깅

- order 관련 데이터는 업데이트 될 때 마다 외부 서비스에 보내주어야합니다. (Kafka mock)

## 11. 향후 확장 고려사항

- **실물 상품** 포함 시: 배송지 입력, 출고 상태, 반품 흐름 추가 필요
- **복합 결제 방식** 도입 시: 잔액 + 카드 결제 등 혼합 구조 추가
- **포인트 또는 캐시백** 적립 시스템 연계
- **사용자별 주문 통계 기반 리마케팅 기능**
