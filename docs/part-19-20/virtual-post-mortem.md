# 가상 장애 대응 회고 문서 (Virtual Post-Mortem)

본 문서는 hh-week-2 서비스에서 발생했다고 가정한 장애 상황을 기반으로 작성된 가상(Post-Mortem) 회고 문서입니다. 시나리오는 `order`, `product`, `coupon`, `wallet` 도메인과 Redis 기반 캐시/락, RDB 인덱스/락, k6 부하 테스트 시나리오를 망라하여 실제 운영에 준하는 대응 및 분석 흐름을 담았습니다.

참고 자료: `docs/part-19-20/load-test-plan.md`, `docs/part-19-20/load-test-analysis.md`, `docs/part-9-10/db-lock-architecture.md`, `docs/part-11-12/redis-caching.md`, `docs/part-11-12/redis-lock.md`

---

## 현상 (Incident Overview)

### 타임라인 (KST)

- 2025-09-03 10:00: 배너 노출과 함께 트래픽 급증 시작 (정상 대비 +300%)
- 2025-09-03 10:05: `product` 상세 조회 p95 180ms → 1.8s 상승, 캐시 적중률 82% → 35% 급락
- 2025-09-03 10:08: DB(Read Replica) CPU 90%+, 연결 대기 증가, 슬로우 쿼리 급증
- 2025-09-03 10:12: `order` 생성 API 타임아웃 증가(p99 7s), 오류율 0.5% → 8.1%
- 2025-09-03 10:15: 장애 인지(알람) - 캐시 적중률 급락, 에러율 상승 경보(SLO Breach)
- 2025-09-03 10:18: 임시 완화 조치 1차(읽기 전용 기능 일부 비활성, 캐시 TTL 상향 + 스탬피드 완화)
- 2025-09-03 10:25: DB 부하 완화 시작, 오류율 3%대로 하락, p95 지연 900ms
- 2025-09-03 10:40: `order` p99 2.5s, 에러율 1.1% 유지, 캐시 적중률 70% 회복
- 2025-09-03 10:55: 임시 완화 조치 2차(서킷브레이커/레이트리밋 조정, 인기상품 프리워밍)
- 2025-09-03 11:10: 지표 정상화(p95 250ms, 에러율 < 0.5%, 캐시 적중률 88%)
- 2025-09-03 11:30: 사후 점검 및 고객 안내 공지 게시

### 영향범위

- 영향 서비스: `product` 상세 조회 API, `order` 생성 API, `coupon` 발급 API 일부 트래픽 지연
- 인프라: Redis(캐시/락), DB(Read Replica), 애플리케이션 인스턴스 오토스케일링 지연
- 관련 스크립트/시나리오: `scripts/k6-order-test`, `scripts/k6-cache-test`, `scripts/k6-lock-test`

### 고객영향도 (비즈니스 임팩트)

- 주문 실패율 피크 8.1%, 지연에 따른 장바구니 이탈 증가 추정 6~9%
- 45분간 결제 시도 지연 및 실패로 매출 손실 추정 2.8~4.3%
- CS 유입: 결제 지연/실패 문의 120건 추정(동기간 평균 대비 +6x)

---

## 조치 내용 (Mitigations & Recovery)

### 장애 원인 (Root Cause)

1. Redis 캐시 적중률 급락과 캐시 스탬피드 발생

- Redis 연결 지연 및 재시도 폭증으로 읽기 실패 시 DB 폴백이 일시에 집중
- 인기 상품 상세/랭킹/추천 조회가 동시 미스 되면서 동일 키에 대한 동시 재계산

2. DB 부하 증폭 및 락 경합

- 읽기 트래픽이 Replica로 쏠리며 CPU/IO 포화, 슬로우 쿼리 급증
- 일부 `order` 흐름에서 `coupon`/`wallet` 관련 DB 락 경합이 악화되어 타임아웃 연쇄

3. 보호장치 미흡

- 캐시 미스 시 동시성 제어(단일플라이트/분산락) 불충분
- 서킷 브레이커/레이트 리밋 기준이 스파이크에 비보수적으로 설정

### 해소 타임라인

- T+03m: 알람 확인 후 장애 브리지 개설
- T+08m: 캐시 TTL 상향, 스탬피드 완화 옵션 적용(Hot Key에 분산락 활성)
- T+20m: 인기 상품 키 프리워밍 배치 실행, 읽기 전용 기능 일부 비활성
- T+40m: DB 쿼리 힌트/인덱스 점검(읽기 경로), 레이트 리밋 상향/조정
- T+65m: 지표 정상화 확인, 고객 공지 및 CS 대응 매뉴얼 배포

### 실제 단기 대응책 (Already Applied)

- Redis 캐시 TTL 상향 및 `stale-while-revalidate` 유사 전략 적용
- Hot key(상품상세/랭킹) 대상 분산락(`redis-lock`) 활성화로 동시 재계산 차단
- 서킷 브레이커 임계치 조정, 읽기 경로 레이트 리밋/백프레셔 적용
- 인기 키 즉시 프리워밍 및 배너 노출 전 프리워밍 배치 트리거 운영 절차 수립

### 후속 대응 계획 (Planned)

- 캐시 미스 시 단일플라이트(Per-key) 보장 구현 및 라이브 테스트
- Redis 장애/지연 상황에 대한 페일오버 및 로컬 캐시 폴백 경로 추가
- 주문/결제/쿠폰 API 전체에 Idempotency-Key 강제화 및 재시도 정책 개선

---

## 분석 (Analysis)

### 5 Whys

1. 왜 주문 API 오류율이 상승했는가?
   - 캐시 적중률 급락으로 DB 조회 지연이 누적되어 타임아웃이 발생했다.
2. 왜 캐시 적중률이 급락했는가?
   - 트래픽 스파이크 시 캐시 스탬피드가 발생했고, Redis 연결 지연으로 미스 복구가 늦어졌다.
3. 왜 스탬피드가 발생했는가?
   - 동일 키 재계산에 대한 동시성 제어(단일플라이트/분산락)가 충분히 적용되지 않았다.
4. 왜 동시성 제어가 충분하지 않았는가?
   - 정상 트래픽 기준으로만 최적화했고, 스파이크/장애 상황을 가정한 k6 시나리오가 부족했다.
5. 왜 장애 상황 시나리오가 부족했는가?
   - 혼합 워크로드(읽기 폭증 + 부분 쓰기)와 Redis 지연/오류 주입을 결합한 테스트가 계획 대비 축소되었다.

보조 인사이트

- `db-lock-architecture.md`에서 정의한 락 전략이 읽기 경로 스파이크와 결합될 때의 영향 분석이 미흡
- `redis-caching.md`, `redis-lock.md`의 권장 설정(타임아웃/재시도/락 만료)에 대한 운영값 재검토 필요

---

## 대응 방안 (Remediation Plan) / 액션 아이템

### Short-term (1주 내)

- Hot key 대상 분산락 기본값 활성화 및 키별 TTL/만료 정책 재설계
- 캐시 미스 단일플라이트 적용(프로세스 내 + 분산, per-key)
- 배너/이벤트 론치 전 프리워밍 체크리스트 및 자동화 스크립트 추가
- 서킷 브레이커/레이트 리밋 기준 상향 및 스파이크 전용 프로파일 도입
- k6 시나리오에 Redis 장애/지연 주입 케이스 추가(`scripts/k6-cache-test` 확장)

### Mid-term (1~4주)

- 로컬 메모리 캐시 레이어 도입(짧은 TTL) + Redis 폴백 하이브리드
- 읽기 경로 쿼리 인덱스/힌트 재점검 및 슬로우쿼리 지속 모니터링 대시보드
- 주문/결제/쿠폰 전체에 Idempotency-Key 강제 및 재시도/타임아웃 정책 통일
- 트래픽 스파이크 대비 오토스케일링 워밍/쿨다운 파라미터 및 최소 인스턴스 상향
- SLO 기반 알람 튜닝(p95/p99, 오류율, 캐시 미스율, Redis 에러율/지연)

### Long-term (4주+)

- CQRS/읽기 전용 서비스 분리(상품상세/랭킹/추천 전용 캐시/서빙 레이어)
- 캐시 프리워밍 파이프라인 상시화(인기/캠페인 키 자동 탐지 및 주기적 재워밍)
- 혼합 워크로드용 성능 회귀 테스트 체계화(k6 + 장애 주입 지속 운영)
- Chaos Engineering(부분 Redis 장애, Read Replica 지연, 네트워크 분리) 정례화
- 결제/지갑/쿠폰 경로 전 구간 멱등성 + 사가/아웃박스 패턴 정착

---

## 메트릭 (요약)

- 피크 오류율: 8.1% → 0.4% 정상화
- p95 지연: 상품상세 1.8s → 250ms, 주문 2.5s → 350ms
- 캐시 적중률: 35% → 88% 회복
- DB(Read Replica) CPU: 90%+ → 45% 이하 안정화

## 후속 조치 상태 추적

- Short-term: 70% 완료(락/TTL/프리워밍/알람), 테스트 항목 잔여
- Mid-term: 설계/POC 진행 중(로컬 캐시 레이어, 인덱스 점검)
- Long-term: 로드맵 반영(CQRS/Chaos/사가)
