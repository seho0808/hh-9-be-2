# 시퀀스 다이어그램 및 동시성 문제 해결방안

## 개요

이 문서는 시스템의 주요 비즈니스 플로우에 대한 시퀀스 다이어그램과 멀티 인스턴스 환경에서 발생할 수 있는 동시성 문제들에 대한 해결방안을 정리합니다.

## 시나리오 중요도 나열

| 시나리오 번호 | 시나리오 설명                        | 중요도 | 동시성 | 이유                                                               |
| ------------- | ------------------------------------ | ------ | ------ | ------------------------------------------------------------------ |
| 4-1           | **정상 결제 흐름**                   | **상** | -      | 시스템의 핵심 비즈니스 플로우. 모든 요소(잔액, 쿠폰, 재고 등) 연계 |
| 4-5           | **결제 중 오류 → 보류 처리 및 복구** | **상** | 5-1    | 예외 발생 시 신뢰 보장 핵심. 원자성·복구 로직 검증 필요            |
| 3-1           | **쿠폰 발급 성공**                   | **상** | **🔐** | **선착순 조건 시 Redis 원자적 연산 필요. 동시성 제어 핵심**        |
| 3-2           | **쿠폰 발급 실패 (소진, 중복 등)**   | **상** | **🔐** | **빈도 높은 예외 + 동시성 문제 해결 필수**                         |
| 5-1           | **보류 주문 → 1분 후 자동 복구**     | **상** | **🔐** | **분산 락 필수. 중복 배치 실행 방지**                              |
| 6-1           | 중복 결제 요청 방지                  | 중     | 🔐     | 멱등성 보장 필수. 동시 요청 처리 방지                              |
| 1-1           | 잔액 충전 성공 및 잔액 조회          | 중     | 🔐     | 멱등성 키로 중복 충전 방지 필요                                    |
| 1-2           | 잔액 충전 실패 (단위, 금액 초과)     | 중     | 🔐     | UX적으로 중요 + 멱등성 검증 처리 필요                              |
| 4-2           | 주문 실패 - 잔액 부족                | 중     | -      | 자주 발생 가능. 단순하지만 빠른 응답 필요                          |
| 4-3           | 주문 실패 - 재고 부족                | 중     | 🔐     | reserve/release 패턴으로 DB 필드 구현. 동시성 해결됨               |
| 4-4           | 주문 실패 - 쿠폰 오류                | 중     | -      | 쿠폰 조건이 다양할 경우 정책 오류 가능성 있음                      |
| 2-1           | 전체 상품 목록 조회                  | 하     | -      | 단순 조회. 실패해도 장애 영향 적음                                 |
| 2-2           | 단일 상품 상세 조회                  | 하     | -      | 동일. 404 외 특별한 로직 없음                                      |
| 7-1           | 인기 상품 조회                       | 하     | -      | 비핵심 기능. 마케팅 성격 강함                                      |

**🔐**: 동시성 해결방안 구현 필요

## 파일 구조

시나리오별로 세부 구현 내용을 분리하여 관리합니다:

- `01-wallet.md` - 잔액 충전 & 조회 흐름 (1-1, 1-2) **🔐 멱등성 키**
- `02-product.md` - 상품 목록 및 단일 조회 (2-1, 2-2)
- `03-coupon.md` - 쿠폰 발급 및 조회 + **선착순 동시성 해결** (3-1, 3-2) **🔐 Redis 원자적 연산**
- `04-order.md` - 결제 프로세스 전체 흐름 (4-1, 4-2, 4-3, 4-4, 4-5) **🔐 재고 db reserve/release 패턴**
- `05-recovery.md` - 보류 주문 자동 복구 + **배치 작업 동시성 해결** (5-1) **🔐 분산 락**
- `06-duplicate.md` - 중복 결제 요청 방지 (6-1) **🔐 멱등성 키**
- `07-popular.md` - 인기 상품 조회 (7-1)

## 전제 사항

- JWT 토큰 사용
- Redis를 활용한 동시성 제어
- 멀티 인스턴스 환경 고려
- 재고 처리는 reserve/release 패턴으로 DB 필드 구현
